@page "/timer/draft"
@rendermode InteractiveServer
@using AkdTimerGV.Components.Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using System.Threading
@inject ProtectedLocalStorage BrowserStorage;
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager;
@inject ILogger<DraftFlow> Logger
<div class="d-flex flex-column">

    <div style="width: 100%">
        <input type="button" value="Reset Drafting Process" onclick="@(() => Lobby.DraftState.Reset())" />
    </div>


    @if (Lobby == null) {

    } else {
        @if (DraftFlowState.START == Lobby.DraftState.FlowState) {
            <input style="vertical-align:middle; font-size: 4em;" type="button" value="Randomize Order" onclick="@(() => Lobby.DraftState.InitializeDraftOrder(Lobby.GetParticipatingTeams()))" />

        } else if (DraftFlowState.ORDER_RANDOMIZED == Lobby.DraftState.FlowState) {
            @for (int i = 0; i < Lobby.DraftState.RandomizedDraftOrder.Count(); i++) {
                <h2>@(i + 1 + " - " + Lobby.DraftState.RandomizedDraftOrder[i])</h2>
            }

            <input type="button" value="Reroll" onclick="@(() => Lobby.DraftState.RerollOrder())" />
            <input type="button" value="Continue" onclick="@(() => ConfirmOrderRandomization())" />
        } else if (DraftFlowState.CHOOSE_GAME == Lobby.DraftState.FlowState) {
            <span>Choose games to add</span>

            <div class="d-grid">
                @foreach (String groupingKey in Lobby.DraftState.ChosenGameDict.Keys) {
                    var grouping = DraftCharacterCache.DraftGroupings[groupingKey];
                    <div style="grid-row: @grouping.Row; grid-column: @grouping.Column">
                        <input type="checkbox" @bind="Lobby.DraftState.ChosenGameDict[grouping.ShortName]" @bind:after="(() => Lobby.DraftState.NotifySubscribers())" /> @grouping.Name
                    </div>
                }
            </div>
                
            <input type="button" value="Unselect all" onclick="@(() => Lobby.DraftState.ResetSelectedGames())" />
            <input type="button" value="Load selected Rosters" onclick="@(() => ConfirmGameSelection())" />

            <hr />
            <h1>OR</h1>
            <hr />
            <textarea @bind="TiermakerCode" rows="5"/>
            <input type="button" value="Load via code" onclick="@(() => LoadTiermakerCode())" />

        } else if (DraftFlowState.DRAFTING_STARTED == Lobby.DraftState.FlowState) {
            <div class="d-flex flex-column">
                <div style="background-color: #1A1A1A; margin: 30px auto 30px auto">
                    <table>

                    @foreach (DraftGrouping draftGrouping in DraftGroupings) {
                        <tr class="flex-container" style="border: 3px solid black;">
                            <td class="draft-label-holder" contenteditable="true">
                                <span class="draft-label">@draftGrouping.Name</span>
                            </td>

                            <td style="width: 640px; height: 64px;">
                                    <!--<Dropzone Items="draftGrouping.Characters" TItem="DraftCharacter" OnItemDrop="@(() => CommitChanges(true))" >-->
                                    <Dropzone ItemWrapperClass="@(item => "grid-item")" Items="draftGrouping.Characters" TItem="DraftCharacter" OnItemDrop="@(() => CommitChanges(true))">
                                    <ChildContent><div class="draft-character-image" style="background-image:url('@context.ImagePath') !important;" /></ChildContent>
                                </Dropzone>
                            </td>
                        </tr>
                    }
                    </table>
                </div>

                <div class="d-flex flex-row" style="margin: 10px auto 40px; width: 1024px;">
                    <Dropzone ItemWrapperClass="@(item => "grid-item")" Items="availableCharacters.Characters" TItem="DraftCharacter" OnItemDrop="@(() => CommitChanges(true))">
                        <ChildContent><div class="draft-character-image" style="background-image:url('@context.ImagePath') !important;" /></ChildContent>
                    </Dropzone>
                </div>
                <input type="button" value="Commit changes" onclick="@(() => CommitChanges(false))" />
                <span><input type="checkbox" @bind="AutoCommit" /> Automatic Commit</span>
                <span><input type="checkbox" @bind="SuppressAutoRefresh" /> Suppress refreshes</span>
                <input type="button" value="Manual refresh" onclick="@(() => refreshFromDraftState(false))" />
                <input type="button" value="End Draft" onclick="@(() => FinishDraft())" />
            </div>

        }
    }
</div>

@code {
    private Lobby Lobby { get; set; }
    private User currentUser { get; set; }
    private bool namesSet = false;
    private Timer Timer;
    private List<DraftGrouping> DraftGroupings = [];
    private DraftGrouping availableCharacters;
    private bool AutoCommit = true;
    private bool SuppressAutoRefresh = false;
    private string TiermakerCode;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (!firstRender) {
            if (Lobby != null) {
                if (Lobby.DraftState.FlowState == DraftFlowState.DRAFTING_FINISHED) {
                    NavigationManager.NavigateTo("/timer/lobby");
                }
                Lobby.DraftState.Subscribe(this);
            }
            return;
        }

        Lobby = await getStoredLobby();
        currentUser = await getStoredUser();
        if (Lobby == null || currentUser == null) {
            await BrowserStorage.DeleteAsync("currentLobby");
            return;
        }

        refreshFromDraftState(false);
        StateHasChanged();
    }

    /// <summary>
    /// Get the LobbyId from the Local Storage
    /// </summary>
    /// <returns></returns>
    private async Task<Lobby?> getStoredLobby() {
        var storedLobby = await BrowserStorage.GetAsync<Guid>("currentLobby");
        Guid? currentLobbyId = storedLobby.Value;
        if (currentLobbyId == null) {
            return null;
        }

        // if the data of the Locally stored lobby is no longer present,
        // then remove the locally saved Lobby id and switch to the main page
        return LobbyHolder.Instance.getLobby((Guid)currentLobbyId);
    }

    /// <summary>
    /// Get the User from the Local Storage
    /// </summary>
    /// <returns></returns>
    private async Task<User?> getStoredUser() {
        var storedUser = await BrowserStorage.GetAsync<Guid>("user");
        Guid? currentUser = storedUser.Value;
        if (currentUser == null) {
            return null;
        }

        // if the data of the Locally stored lobby is no longer present,
        // then remove the locally saved Lobby id and switch to the main page
        return UserHolder.GetUserById((Guid)currentUser);
    }


    private void ConfirmOrderRandomization() {
        Lobby.DraftState.AdvanceState();
        foreach (String team in Lobby.DraftState.RandomizedDraftOrder) {
            DraftGrouping teamGrouping = new DraftGrouping(team);
            teamGrouping.IsPlayer = true;
            Lobby.DraftState.DraftGroupings.Add(team, teamGrouping);
        }
        refreshFromDraftState(false);
    }

    private void ConfirmGameSelection() {
        List<DraftCharacter> draftCharacters = [];

        foreach (KeyValuePair<String, Boolean> game in Lobby.DraftState.ChosenGameDict) {
            if (game.Value) {
                draftCharacters.AddRange(DraftCharacterCache.DraftGroupings[game.Key].Characters);
            }
        }

        Lobby.DraftState.SetAvailableCharacters(draftCharacters);
        foreach (DraftGrouping grouping in Lobby.DraftState.DraftGroupings.Values) {
            grouping.Characters = [];

        }
        Lobby.DraftState.AdvanceState();
    }

    private void LoadTiermakerCode() {
        if (!TiermakerCode.StartsWith("fe")) {
            return;
        }

        Lobby.DraftState.ResetSelectedGames();
        // Example code: fe==Free|0|eng-6|eng-5==Banned|1|eng-7
        // can ignore first FE== free
        // After split by == so we have each tier in a separate string.
        // Then split by |
        // index = tier name, index = 1 color (can ignore), after character shortnames
        String[] tiers = TiermakerCode.Substring(4).Split("==");
        List<String> charactersToMove = [];

        List<DraftGrouping> NewGroupings = [];

        foreach (String tier in tiers) {
            String[] Components = tier.Split("|");
            DraftGrouping groupingToAdd = new DraftGrouping(Components[0]);
            NewGroupings.Add(groupingToAdd);
            for (int i = 2; i < Components.Length; i++) {
                String ShortName = Components[i];
                String GameShortName = ShortName.Split("-")[0];
                int CharacterIndex = int.Parse(ShortName.Split("-")[1]);

                Lobby.DraftState.ChosenGameDict[GameShortName] = true;
                charactersToMove.Add(ShortName);
                groupingToAdd.Characters.Add(DraftCharacterCache.DraftGroupings[GameShortName].Characters[CharacterIndex]);
            }
        }

        ConfirmGameSelection();



        foreach (DraftGrouping draftGrouping in NewGroupings) {
            Lobby.DraftState.DraftGroupings.Add(draftGrouping.Name, draftGrouping);
        }
        Lobby.DraftState.AvailableCharacters.Characters.RemoveAll(dc => charactersToMove.Contains(dc.ShortName));
        Lobby.DraftState.NotifySubscribers();
    }

    private void FinishDraft() {
        foreach (DraftGrouping dg in Lobby.DraftState.DraftGroupings.Values) {
            Team? team = Lobby.GetTeamByName(dg.Name);
            if (dg.IsPlayer && team!=null) {
                team.TimerData.DraftedCharacters = dg.Characters;
            }
        }

        Lobby.DraftState.AdvanceState();
    }

    public void CommitChanges(bool automatic) {
        if (automatic && !AutoCommit) {
            return;
        }
        Lobby.DraftState.UpdateState(DraftGroupings, availableCharacters);
    }

    public void refreshFromDraftState(bool automatic) {
        InvokeAsync(() => {
            if (automatic && SuppressAutoRefresh) {
                return;
            }

            DraftGroupings = Lobby.DraftState.DraftGroupings.Values.Select(value => value.clone()).ToList();
            availableCharacters = Lobby.DraftState.AvailableCharacters.clone();
            StateHasChanged();
        });
    }

    public void Dispose() {
        if (Lobby != null) {
            Lobby.DraftState.Unsubscribe(this);
        }
    }
}
